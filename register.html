<!-- HTML: register.html -->
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet"/>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: 'Prompt', sans-serif;
      background-color: #f0f8ff;
      padding: 20px;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #2176bd;
    }
    form {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .form-section {
      display: none;
    }
    .form-section.active {
      display: block;
    }
    button {
      margin-top: 20px;
      padding: 12px;
      width: 100%;
      border: none;
      background-color: #2176bd;
      color: white;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .checkbox-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .loading {
      display: none;
      text-align: center;
      margin-top: 20px;
    }
    .loading.active {
      display: block;
    }
    .popup {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.4);
      z-index: 999;
      justify-content: center;
      align-items: center;
    }
    .popup-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 400px;
      text-align: center;
    }
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h1>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h1>
  <div id="loading" class="loading"><div class="spinner"></div><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p></div>
  <form id="register-form" style="display:none">
    <!-- Form Steps ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
  </form>

  <div class="popup" id="popup">
    <div class="popup-content" id="popup-content">
      <!-- Message here -->
    </div>
  </div>

  <script>
    let lineUserId = "";

    async function initApp() {
      await liff.init({ liffId: "2007700107-rDd1AD1M" });
      if (!liff.isLoggedIn()) liff.login();
      const profile = await liff.getProfile();
      lineUserId = profile.userId;
      const response = await fetch(`https://script.google.com/macros/s/AKfycbznTaneNaGDoTwT9Xsgq9XCZDOSspbAbuqeLvkC1teurkY2PwYbk27evsmkULQWONE/exec?action=getUser&line_user_id=${lineUserId}`);
      const user = await response.json();

      document.getElementById("loading").style.display = "none";

      if (user && user.cid) {
        const form = document.getElementById("register-form");
        form.innerHTML = `
          <p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì ${user.first_name}</p>
          <p>‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
          <p>‡∏ä‡∏∑‡πà‡∏≠: ${user.prefix}${user.first_name} ${user.last_name}</p>
          <p>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î: ${user.birthdate}</p>
          <p>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£: ${user.cid}</p>
          <p>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: ${user.address_no} ‡∏°.${user.address_moo} ‡∏ï.${user.address_tambon} ‡∏≠.${user.address_amphur} ‡∏à.${user.address_province}</p>
          <p>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: ${user.phone}</p>
          <p>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${user.is_pregnant ? '‡∏´‡∏ç‡∏¥‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå' : user.is_postpartum ? '‡πÅ‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏•‡∏≠‡∏î' : '‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}</p>
          <button onclick="showEditForm(user)">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        `;
        form.style.display = "block";
      } else {
        showFormStep1();
      }
    }

    function showFormStep1() {
      const form = document.getElementById("register-form");
      form.style.display = "block";
      form.innerHTML = `
        <div class="form-section active" id="step-1">
          <label>‡∏ä‡∏∑‡πà‡∏≠ *</label><input name="first_name" required />
          <label>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label><input name="last_name" required />
          <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ *</label><input name="phone" required />
          <button type="button" onclick="showConsentStep()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>
      `;
    }

    function showConsentStep() {
      const form = document.getElementById("register-form");
      form.innerHTML = `
        <div class="form-section active" id="step-2">
                    <p>
        <strong>‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</strong><br>
        ‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô MCH Yaha Care Center ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏° ‡πÉ‡∏ä‡πâ ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏°‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏î‡πá‡∏Å ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ ‡∏ï‡∏•‡∏≠‡∏î‡∏à‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û ‡πÇ‡∏î‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ PDPA
      </p>
          <label><input type="checkbox" id="consent-box"/> ‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</label>
          <button id="submit-btn" disabled onclick="submitForm()">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
        </div>
      `;
      document.getElementById("consent-box").addEventListener("change", function() {
        document.getElementById("submit-btn").disabled = !this.checked;
      });
    }

    function submitForm() {
      const formData = new FormData(document.querySelector("#register-form"));
      formData.append("line_user_id", lineUserId);
      formData.append("line_registered_at", new Date().toISOString());
      document.getElementById("loading").classList.add("active");

      fetch("https://script.google.com/macros/s/AKfycbznTaneNaGDoTwT9Xsgq9XCZDOSspbAbuqeLvkC1teurkY2PwYbk27evsmkULQWONE/exec", {
        method: "POST",
        body: formData
      }).then(r => r.json()).then(data => {
        document.getElementById("loading").classList.remove("active");
        const popup = document.getElementById("popup");
        document.getElementById("popup-content").innerHTML = `
          <h3>üè• ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô MCH Yaha Care Center</h3>
          <p>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
          ${data.is_high_risk_pregnancy ? '<p style="color:red;">‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ç‡∏¥‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</p>' : ''}
          <button onclick="popup.classList.remove('active')">‡∏õ‡∏¥‡∏î</button>
        `;
        popup.classList.add("active");
      });
    }

    initApp();
  </script>
</body>
</html>
