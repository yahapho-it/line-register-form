<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet"/>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: 'Prompt', sans-serif;
      background-color: #f0f8ff;
      padding: 20px;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #2176bd;
    }
    form {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .form-section {
      display: none;
    }
    .form-section.active {
      display: block;
    }
    button {
      margin-top: 20px;
      padding: 12px;
      width: 100%;
      border: none;
      background-color: #2176bd;
      color: white;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .checkbox-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .loading {
      display: none;
      text-align: center;
      margin-top: 20px;
    }
    .loading.active {
      display: block;
    }
    .popup {
      display: none;
      position: fixed;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 2px solid #4ab3e4;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 999;
    }
    .popup.active {
      display: block;
    }
  </style>
</head>
<body>
  <h1>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h1>
  <form id="register-form">
    <input type="hidden" name="user_id" />
    <!-- Step 1 -->
    <div class="form-section active" id="step-1">
      <label>‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ *</label>
      <select name="prefix" required>
        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
        <option value="‡∏ô.‡∏™.">‡∏ô.‡∏™.</option>
        <option value="‡∏ô‡∏≤‡∏á">‡∏ô‡∏≤‡∏á</option>
        <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
        <option value="‡∏î.‡∏ç.">‡∏î.‡∏ç.</option>
        <option value="‡∏î.‡∏ä.">‡∏î.‡∏ä.</option>
        <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
      </select>
      <label>‡∏ä‡∏∑‡πà‡∏≠ *</label>
      <input name="first_name" required />
      <label>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label>
      <input name="last_name" required />
      <label>‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î *</label>
      <input type="date" name="birthdate" required />
      <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô *</label>
      <input name="cid" maxlength="13" pattern="\d{13}" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å" required />
      <label>‡πÄ‡∏û‡∏®</label>
      <select name="gender">
        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
        <option value="‡∏´‡∏ç‡∏¥‡∏á">‡∏´‡∏ç‡∏¥‡∏á</option>
        <option value="‡∏ä‡∏≤‡∏¢">‡∏ä‡∏≤‡∏¢</option>
        <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
      </select>
      <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå *</label>
      <input name="phone" maxlength="10" pattern="\d{10}" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå 10 ‡∏´‡∏•‡∏±‡∏Å" required />
      <label>‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</label>
      <input name="address_no" />
      <label>‡∏´‡∏°‡∏π‡πà</label>
      <input name="address_moo" />
      <label>‡∏ï‡∏≥‡∏ö‡∏•</label>
      <input name="address_tambon" />
      <label>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
      <input name="address_amphur" />
      <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
      <input name="address_province" />
      <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
      <div class="checkbox-group">
        <label><input type="checkbox" name="is_pregnant" value="TRUE"> ‡∏´‡∏ç‡∏¥‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå</label>
        <label><input type="checkbox" name="is_postpartum" value="TRUE"> ‡∏´‡∏ç‡∏¥‡∏á‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏•‡∏≠‡∏î</label>
        <label><input type="checkbox" name="is_general_user" value="TRUE"> ‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</label>
      </div>
      <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)</label>
      <select name="related_to_mother_type">
        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
        <option value="self">‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</option>
        <option value="partner">‡πÅ‡∏ü‡∏ô</option>
        <option value="husband">‡∏™‡∏≤‡∏°‡∏µ</option>
        <option value="family">‡∏ç‡∏≤‡∏ï‡∏¥</option>
        <option value="friend">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</option>
        <option value="staff">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</option>
        <option value="other">‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
      </select>
      <button type="button" onclick="nextStep()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
    </div>

    <!-- Step 2 -->
    <div class="form-section" id="step-2">
      <p>
        <strong>‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</strong><br>
        ‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô MCH Yaha Care Center ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏° ‡πÉ‡∏ä‡πâ ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏°‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏î‡πá‡∏Å...
      </p>
      <label><input type="checkbox" id="consent-box"/> ‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</label>
      <button type="submit" id="submit-btn" disabled>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
    </div>
    <div class="loading" id="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
  </form>
  <div class="popup" id="popup"></div>

  <script>
    let currentStep = 1;
    function nextStep() {
      document.getElementById("step-1").classList.remove("active");
      document.getElementById("step-2").classList.add("active");
    }
    document.getElementById("consent-box").addEventListener("change", function() {
      document.getElementById("submit-btn").disabled = !this.checked;
    });

    let lineUserId = "", lineDisplayName = "", linePictureUrl = "";
    liff.init({ liffId: "2007700107-rDd1AD1M" }).then(() => {
      if (!liff.isLoggedIn()) liff.login();
      else return liff.getProfile();
    }).then(profile => {
      lineUserId = profile.userId;
      lineDisplayName = profile.displayName;
      linePictureUrl = profile.pictureUrl;

      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Apps Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏´‡∏°
      return fetch(`https://script.google.com/macros/s/AKfycbznTaneNaGDoTwT9Xsgq9XCZDOSspbAbuqeLvkC1teurkY2PwYbk27evsmkULQWONE/exec?check_user=true&line_user_id=${lineUserId}`);
    })
    .then(res => res.json())
    .then(data => {
      if (data && data.user_id) {
        document.querySelector('[name="user_id"]').value = data.user_id;
        document.querySelector('[name="prefix"]').value = data.prefix || "";
        document.querySelector('[name="first_name"]').value = data.first_name || "";
        document.querySelector('[name="last_name"]').value = data.last_name || "";
        document.querySelector('[name="birthdate"]').value = data.birthdate || "";
        document.querySelector('[name="cid"]').value = data.cid || "";
        document.querySelector('[name="gender"]').value = data.gender || "";
        document.querySelector('[name="phone"]').value = data.phone || "";
        document.querySelector('[name="address_no"]').value = data.address_no || "";
        document.querySelector('[name="address_moo"]').value = data.address_moo || "";
        document.querySelector('[name="address_tambon"]').value = data.address_tambon || "";
        document.querySelector('[name="address_amphur"]').value = data.address_amphur || "";
        document.querySelector('[name="address_province"]').value = data.address_province || "";
        document.querySelector('[name="related_to_mother_type"]').value = data.related_to_mother_type || "";
        document.querySelector('[name="is_pregnant"]').checked = data.is_pregnant === "TRUE";
        document.querySelector('[name="is_postpartum"]').checked = data.is_postpartum === "TRUE";
        document.querySelector('[name="is_general_user"]').checked = data.is_general_user === "TRUE";
      }
    });

    document.getElementById("register-form").addEventListener("submit", function(e) {
      e.preventDefault();
      const form = new FormData(e.target);
      form.append("line_user_id", lineUserId);
      form.append("line_display_name", lineDisplayName);
      form.append("line_picture_url", linePictureUrl);
      form.append("line_registered_at", new Date().toISOString());

      document.getElementById("loading").classList.add("active");

      fetch("https://script.google.com/macros/s/AKfycbznTaneNaGDoTwT9Xsgq9XCZDOSspbAbuqeLvkC1teurkY2PwYbk27evsmkULQWONE/exec", {
        method: "POST",
        body: form
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById("loading").classList.remove("active");
        const popup = document.getElementById("popup");
        let message = "<h3>üè• ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô MCH Yaha Care Center</h3><p>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>";
        if (data.is_high_risk_pregnancy === true) {
          message += '<p style="color:red;">‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ç‡∏¥‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</p>';
        }
        message += '<br><button onclick="window.location.reload()">‡∏õ‡∏¥‡∏î</button>';
        popup.innerHTML = message;
        popup.classList.add("active");
      });
    });
  </script>
</body>
</html>
