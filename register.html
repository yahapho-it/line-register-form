<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet"/>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: 'Prompt', sans-serif;
      background-color: #f0f8ff;
      padding: 20px;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #2176bd;
    }
    form {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .form-section {
      display: none;
    }
    .form-section.active {
      display: block;
    }
    button {
      margin-top: 20px;
      padding: 12px;
      width: 100%;
      border: none;
      background-color: #2176bd;
      color: white;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .checkbox-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .loading {
      display: none;
      text-align: center;
      margin-top: 20px;
    }
    .loading.active {
      display: block;
    }
    .popup {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    .popup-content {
      background: white;
      padding: 30px;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      text-align: center;
    }
    .popup.active {
      display: flex;
    }
    #existing-info {
      background: white;
      padding: 20px;
      border-radius: 12px;
      max-width: 600px;
      margin: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: none;
    }
  </style>
</head>
<body>
  <h1>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h1>
  <div id="existing-info"></div>
  <form id="register-form">
    <!-- Step 1 -->
    <div class="form-section active" id="step-1">[...‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏î‡∏¥‡∏°...]</div>

    <!-- Step 2 -->
    <div class="form-section" id="step-2">[...‡∏´‡∏ô‡πâ‡∏≤‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°...]
    </div>

    <div class="loading" id="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
  </form>

  <div class="popup" id="popup">
    <div class="popup-content" id="popup-content"></div>
    <button onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>
  </div>

  <script>
    let currentStep = 1;
    function nextStep() {
      document.getElementById("step-1").classList.remove("active");
      document.getElementById("step-2").classList.add("active");
    }

    function closePopup() {
      document.getElementById("popup").classList.remove("active");
    }

    document.getElementById("consent-box").addEventListener("change", function() {
      document.getElementById("submit-btn").disabled = !this.checked;
    });

    let lineUserId = "", lineDisplayName = "", linePictureUrl = "";
    liff.init({ liffId: "2007700107-rDd1AD1M" }).then(() => {
      if (!liff.isLoggedIn()) liff.login();
      else return liff.getProfile();
    }).then(profile => {
      lineUserId = profile.userId;
      lineDisplayName = profile.displayName;
      linePictureUrl = profile.pictureUrl;
      checkExistingUser(lineUserId);
    });

    function checkExistingUser(userId) {
      fetch(`https://script.google.com/macros/s/AKfycbznTaneNaGDoTwT9Xsgq9XCZDOSspbAbuqeLvkC1teurkY2PwYbk27evsmkULQWONE/exec?check_user=true&line_user_id=${userId}`)
      .then(res => res.json())
      .then(data => {
        if (data.found) {
          const infoDiv = document.getElementById("existing-info");
          infoDiv.innerHTML = `
            <h3>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${data.first_name}</h3>
            <p>‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
            <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${data.first_name} ${data.last_name}</p>
            <p><strong>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î:</strong> ${data.birthdate}</p>
            <p><strong>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£:</strong> ${data.cid}</p>
            <p><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> ${data.address_no} ‡∏´‡∏°‡∏π‡πà ${data.address_moo} ‡∏ï.${data.address_tambon} ‡∏≠.${data.address_amphur} ‡∏à.${data.address_province}</p>
            <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå:</strong> ${data.phone}</p>
            <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${(data.is_pregnant === 'TRUE' ? '‡∏´‡∏ç‡∏¥‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå ' : '') + (data.is_postpartum === 'TRUE' ? '‡πÅ‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏•‡∏≠‡∏î' : '')}</p>
            <p>‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
            <button onclick="showEditForm()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          `;
          infoDiv.style.display = "block";
          document.getElementById("register-form").style.display = "none";
        }
      });
    }

    function showEditForm() {
      document.getElementById("existing-info").style.display = "none";
      document.getElementById("register-form").style.display = "block";
    }

    document.getElementById("register-form").addEventListener("submit", function(e) {
      e.preventDefault();
      const form = new FormData(e.target);
      form.append("line_user_id", lineUserId);
      form.append("line_display_name", lineDisplayName);
      form.append("line_picture_url", linePictureUrl);
      form.append("line_registered_at", new Date().toISOString());

      document.getElementById("loading").classList.add("active");

      fetch("https://script.google.com/macros/s/AKfycbznTaneNaGDoTwT9Xsgq9XCZDOSspbAbuqeLvkC1teurkY2PwYbk27evsmkULQWONE/exec", {
        method: "POST",
        body: form
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById("loading").classList.remove("active");
        const popup = document.getElementById("popup");
        const content = document.getElementById("popup-content");
        let message = `<h3>üè• ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô MCH Yaha Care Center</h3><p>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>`;
        if (data.is_high_risk_pregnancy === true) {
          message += '<p style="color:red;">‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ç‡∏¥‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</p>';
        }
        content.innerHTML = message;
        popup.classList.add("active");
      });
    });
  </script>
</body>
</html>
