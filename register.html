<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô - MCH YAHA Care Center</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #FFE5E5 0%, #E8F4FD 50%, #F0E6FF 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 650px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .header {
            background: linear-gradient(135deg, #FFB6C1 0%, #FFC0CB 50%, #DDA0DD 100%);
            color: #2C3E50;
            padding: 35px;
            text-align: center;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
        }

        .header .subtitle {
            font-size: 18px;
            opacity: 0.9;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        .form-container {
            padding: 40px;
            background: linear-gradient(135deg, #FAFAFA 0%, #F8F9FA 100%);
        }

        .form-section {
            margin-bottom: 30px;
            padding: 25px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            border: 1px solid rgba(255,192,203,0.3);
        }

        .form-section h3 {
            color: #8B4B8C;
            font-size: 20px;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2C3E50;
            font-size: 16px;
        }

        .required {
            color: #FF6B9D;
        }

        .form-control {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #E8E8E8;
            border-radius: 15px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #FAFAFA 0%, #FFFFFF 100%);
            color: #2C3E50;
        }

        .form-control:focus {
            outline: none;
            border-color: #FFB6C1;
            background: white;
            box-shadow: 0 0 0 4px rgba(255, 182, 193, 0.1);
            transform: translateY(-2px);
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #FFF5F8 0%, #F0F8FF 100%);
            border-radius: 15px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .checkbox-item:hover {
            background: linear-gradient(135deg, #FFE5E5 0%, #E8F4FD 100%);
            border-color: #FFB6C1;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 182, 193, 0.2);
        }

        .checkbox-item input[type="checkbox"] {
            width: 22px;
            height: 22px;
            margin-right: 15px;
            cursor: pointer;
            accent-color: #FFB6C1;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
            color: #2C3E50;
            font-size: 16px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            background: linear-gradient(135deg, #FFF5F8 0%, #F0F8FF 100%);
            border-radius: 25px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            flex: 1;
            justify-content: center;
        }

        .radio-item:hover {
            background: linear-gradient(135deg, #FFE5E5 0%, #E8F4FD 100%);
            border-color: #FFB6C1;
            transform: translateY(-2px);
        }

        .radio-item input[type="radio"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
            accent-color: #FFB6C1;
        }

        .radio-item label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
            color: #2C3E50;
            font-size: 16px;
        }

        .submit-btn {
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, #FFB6C1 0%, #FF91A4 100%);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 30px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(255, 182, 193, 0.4);
            background: linear-gradient(135deg, #FF91A4 0%, #FFB6C1 100%);
        }

        .submit-btn:disabled {
            background: linear-gradient(135deg, #E0E0E0 0%, #C0C0C0 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            border: 4px solid #F3F3F3;
            border-top: 4px solid #FFB6C1;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #FF6B9D;
            font-size: 14px;
            margin-top: 8px;
            display: none;
            font-weight: 500;
        }

        .success-message {
            background: linear-gradient(135deg, #E8F5E8 0%, #F0FFF0 100%);
            color: #2E7D32;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: none;
            font-weight: 600;
            border: 2px solid #C8E6C9;
        }

        .consent-text {
            font-size: 14px;
            line-height: 1.6;
            color: #555;
            background: #F8F9FA;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #FFB6C1;
        }

        .address-fields {
            display: grid;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .radio-group {
                flex-direction: column;
                gap: 10px;
            }
            
            .container {
                margin: 10px;
            }
            
            .header h1 {
                font-size: 26px;
            }
            
            .form-container {
                padding: 25px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå∏ MCH YAHA Care Center üå∏</h1>
            <div class="subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ç‡∏¥‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏•‡∏≠‡∏î</div>
            <div id="greeting" style="margin-top: 10px; font-size: 16px; color: #2C3E50;"></div>
        </div>

        <div class="form-container">
            <div class="success-message" id="successMessage">
                ‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà MCH YAHA Care Center
            </div>

            <form action="https://script.google.com/macros/s/AKfycbznTaneNaGDoTwT9Xsgq9XCZDOSspbAbuqeLvkC1teurkY2PwYbk27evsmkULQWONE/exec" 
                  method="POST" id="registrationForm">
              
              <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏° -->
              <div class="form-section">
                <h3>üìã ‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                <div class="consent-text">
                  <strong>‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</strong><br><br>
                  ‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô MCH Yaha Care Center ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏° ‡πÉ‡∏ä‡πâ ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏°‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏î‡πá‡∏Å ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ ‡∏ï‡∏•‡∏≠‡∏î‡∏à‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û ‡πÇ‡∏î‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ PDPA
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="consent" name="consent" required>
                  <label for="consent">‚úÖ ‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏•‡∏∞‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• <span class="required">*</span></label>
                </div>
                  <div class="error-message" id="consentError"></div>
              </div>
            
              <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß -->
              <div class="form-section">
                <h3>üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>

                <div class="form-row">
                  <div class="form-group">
                    <label for="cid">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô <span class="required">*</span></label>
                    <input type="text" class="form-control" id="cid" name="cid" maxlength="13" required onblur="checkCIDInDatabase()">
                      <div class="error-message" id="cidError"></div>
                      <div class="error-message" id="cidHint"></div>
                  </div>
                  <div class="form-group">
                    <label for="phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå <span class="required">*</span></label>
                    <input type="tel" class="form-control" id="phone" name="phone" maxlength="10" required>
                      <div class="error-message" id="phoneError"></div>
                  </div>
                </div>
                  
                <div class="form-row">
                  <div class="form-group">
                    <label for="prefix">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ <span class="required">*</span></label>
                    <select class="form-control" id="prefix" name="prefix" required>
                      <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</option>
                      <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
                      <option value="‡∏ô‡∏≤‡∏á">‡∏ô‡∏≤‡∏á</option>
                      <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
                      <option value="‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢">‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢</option>
                      <option value="‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á">‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á</option>
                    </select>
                      <div class="error-message" id="prefixError"></div>
                  </div>
                </div>
            
                <div class="form-row">
                  <div class="form-group">
                    <label for="firstName">‡∏ä‡∏∑‡πà‡∏≠ <span class="required">*</span></label>
                    <input type="text" class="form-control" id="firstName" name="first_name" required>
                      <div class="error-message" id="firstNameError"></div>
                  </div>
                  <div class="form-group">
                    <label for="lastName">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="required">*</span></label>
                    <input type="text" class="form-control" id="lastName" name="last_name" required>
                      <div class="error-message" id="lastNameError"></div>
                  </div>
                </div>
            
                <div class="form-row">
                  <div class="form-group">
                    <label>‡πÄ‡∏û‡∏® <span class="required">*</span></label>
                    <div class="radio-group">
                      <div class="radio-item">
                        <input type="radio" id="male" name="gender" value="‡∏ä‡∏≤‡∏¢" required>
                        <label for="male">üë® ‡∏ä‡∏≤‡∏¢</label>
                      </div>
                      <div class="radio-item">
                        <input type="radio" id="female" name="gender" value="‡∏´‡∏ç‡∏¥‡∏á" required>
                        <label for="female">üë© ‡∏´‡∏ç‡∏¥‡∏á</label>
                      </div>
                    </div>
                      <div class="error-message" id="genderError"></div>
                  </div>
                  <div class="form-group">
                    <label for="birthdate">‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î <span class="required">*</span></label>
                    <input type="date" class="form-control" id="birthdate" name="birthdate" required>
                      <div class="error-message" id="birthdateError"></div>
                  </div>
                </div>
              </div>
            
              <!-- ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà -->
              <div class="form-section">
                <h3>üìç ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</h3>
                <div class="address-fields">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="province">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î <span class="required">*</span></label>
                      <select class="form-control" id="province" name="address_province" required>
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>
                      </select>
                        <div class="error-message" id="provinceError"></div>
                    </div>
                    <div class="form-group">
                      <label for="amphur">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ <span class="required">*</span></label>
                      <select class="form-control" id="amphur" name="address_amphur" required disabled>
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option>
                      </select>
                        <div class="error-message" id="amphurError"></div>
                    </div>
                  </div>
            
                  <div class="form-row">
                    <div class="form-group">
                      <label for="tambon">‡∏ï‡∏≥‡∏ö‡∏• <span class="required">*</span></label>
                      <select class="form-control" id="tambon" name="address_tambon" required disabled>
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>
                      </select>
                        <div class="error-message" id="tambonError"></div>
                    </div>
                    <div class="form-group">
                      <label for="moo">‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà</label>
                      <input type="text" class="form-control" id="moo" name="address_moo">
                    </div>
                  </div>
            
                  <div class="form-group">
                    <label for="addressDetail">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà/‡∏ñ‡∏ô‡∏ô <span class="required">*</span></label>
                    <input type="text" class="form-control" id="addressDetail" name="address_no" required>
                      <div class="error-message" id="addressDetailError"></div>
                  </div>
                </div>
              </div>
            
              <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ -->
              <div class="form-section">
                <h3>üë©‚Äç‚öïÔ∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
                <div class="checkbox-group">
                  <div class="checkbox-item">
                    <input type="checkbox" id="isPregnant" name="is_pregnant" value="1">
                    <label for="isPregnant">ü§∞ ‡∏´‡∏ç‡∏¥‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå</label>
                  </div>
                  <div class="checkbox-item">
                    <input type="checkbox" id="isPostpartum" name="is_postpartum" value="1">
                    <label for="isPostpartum">üë©‚Äçüçº ‡∏°‡∏≤‡∏£‡∏î‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏•‡∏≠‡∏î</label>
                  </div>
                  <div class="checkbox-item">
                    <input type="checkbox" id="isGeneral" name="is_general_user" value="1">
                    <label for="isGeneral">üë• ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</label>
                  </div>
                </div>
                  <div class="error-message" id="userTypeError"></div>
              </div>

                <input type="hidden" name="line_user_id" id="lineUserId">
                <input type="hidden" name="line_display_name" id="lineDisplayName">
                <input type="hidden" name="line_picture_url" id="linePictureUrl">
                <input type="hidden" name="age_today" id="ageToday">

            
              <button type="submit" class="submit-btn" id="submitBtn">
                üå∏ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
              </button>
            </form>


            <div class="loading" id="loadingDiv">
                <div class="loading-spinner"></div>
                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
        </div>
    </div>

    <script>
    const LIFF_ID = '2007700107-rDd1AD1M';
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbznTaneNaGDoTwT9Xsgq9XCZDOSspbAbuqeLvkC1teurkY2PwYbk27evsmkULQWONE/exec';

    let userProfile = null;
    let isProfileLoaded = false; 
    let addressData = {
        provinces: [],
        amphurs: [],
        tambons: []
    };
    
    const registrationForm = document.getElementById("registrationForm");
    const submitBtn = document.getElementById("submitBtn");
    const loadingDiv = document.getElementById("loadingDiv");
    const successMessage = document.getElementById("successMessage");
    
    registrationForm.addEventListener("submit", async function (event) {
      event.preventDefault();

  const data = collectFormData();
  if (!validateForm()) return;

  registrationForm.style.display = "none";
  loadingDiv.style.display = "block";

  try {
    const formData = new FormData();
    for (const key in data) {
      formData.append(key, data[key]);
    }

    const response = await fetch(APPS_SCRIPT_URL, {
      method: "POST",
      body: formData
    });

    successMessage.style.display = "block";
  } catch (error) {
    console.error("‚ùå Error:", error);
    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + error.message);
    registrationForm.style.display = "block";
  } finally {
    loadingDiv.style.display = "none";
  }
});

window.onload = function() {
  initializeLiff();
  loadProvinces();
  setupEventListeners();
};

function initializeLiff() {
  liff.init({ liffId: LIFF_ID })
    .then(() => {
      if (liff.isLoggedIn()) {
        getUserProfile();
      } else {
        liff.login();
      }
    })
    .catch((err) => {
      console.error('LIFF initialization failed', err);
    });
}

function getUserProfile() {
  liff.getProfile().then((profile) => {
    userProfile = profile;
    isProfileLoaded = true;
    console.log('User profile:', profile);
    document.getElementById("lineUserId").value = profile.userId;
    document.getElementById("lineDisplayName").value = profile.displayName;
    document.getElementById("linePictureUrl").value = profile.pictureUrl;
    const greeting = document.getElementById("greeting");
    greeting.textContent = `üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì ${profile.displayName}`;
  }).catch((err) => {
    console.error('Error getting user profile', err);
  });
}

function setupEventListeners() {
 document.addEventListener('DOMContentLoaded', function () {
    const cidInput = document.getElementById('cid');
    if (cidInput) {
      cidInput.addEventListener('blur', checkCIDInDatabase);
    }
  });
    
  document.getElementById('consent').addEventListener('change', function() {
    submitBtn.disabled = !this.checked;
  });

  document.getElementById('province').addEventListener('change', function() {
    loadAmphurs(this.value);
  });

  document.getElementById('amphur').addEventListener('change', function() {
    loadTambons(this.value);
  });

  document.getElementById('cid').addEventListener('input', function(e) {
    this.value = this.value.replace(/\D/g, '');
  });

  document.getElementById('phone').addEventListener('input', function(e) {
    this.value = this.value.replace(/\D/g, '');
  });

  document.getElementById("birthdate").addEventListener("change", function () {
    const age = calculateAge(this.value);
    document.getElementById("ageToday").value = age;
  });
}

async function loadProvinces() {
  try {
    const response = await fetch('https://raw.githubusercontent.com/kongvut/thai-province-data/master/api_province.json');
    const provinces = await response.json();
    addressData.provinces = provinces;

    const provinceSelect = document.getElementById('province');
    provinceSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>';

    provinces.forEach(province => {
      const option = document.createElement('option');
      option.value = province.id;
      option.textContent = province.name_th;
      provinceSelect.appendChild(option);
    });

    const yalaOption = provinces.find(p => p.name_th === '‡∏¢‡∏∞‡∏•‡∏≤');
    if (yalaOption) {
      provinceSelect.value = yalaOption.id;
      loadAmphurs(yalaOption.id);
    }
  } catch (error) {
    console.error('Error loading provinces:', error);
  }
}

async function loadAmphurs(provinceId) {
  if (!provinceId) {
    document.getElementById('amphur').innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option>';
    document.getElementById('amphur').disabled = true;
    document.getElementById('tambon').innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>';
    document.getElementById('tambon').disabled = true;
    return;
  }

  try {
    const response = await fetch('https://raw.githubusercontent.com/kongvut/thai-province-data/master/api_amphure.json');
    const amphurs = await response.json();
    const filteredAmphurs = amphurs.filter(a => a.province_id == provinceId);
    addressData.amphurs = filteredAmphurs;

    const amphurSelect = document.getElementById('amphur');
    amphurSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option>';

    filteredAmphurs.forEach(amphur => {
      const option = document.createElement('option');
      option.value = amphur.id;
      option.textContent = amphur.name_th;
      amphurSelect.appendChild(option);
    });

    amphurSelect.disabled = false;
    document.getElementById('tambon').innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>';
    document.getElementById('tambon').disabled = true;
  } catch (error) {
    console.error('Error loading amphurs:', error);
  }
}

async function loadTambons(amphurId) {
  if (!amphurId) {
    document.getElementById('tambon').innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>';
    document.getElementById('tambon').disabled = true;
    return;
  }

  try {
    const response = await fetch('https://raw.githubusercontent.com/kongvut/thai-province-data/master/api_tambon.json');
    const tambons = await response.json();
    const filteredTambons = tambons.filter(t => t.amphure_id == amphurId);
    addressData.tambons = filteredTambons;

    const tambonSelect = document.getElementById('tambon');
    tambonSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>';

    filteredTambons.forEach(tambon => {
      const option = document.createElement('option');
      option.value = tambon.id;
      option.textContent = tambon.name_th;
      tambonSelect.appendChild(option);
    });

    tambonSelect.disabled = false;
  } catch (error) {
    console.error('Error loading tambons:', error);
  }
}

function validateForm() {
  let isValid = true;
  document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');

  const requiredFields = ['prefix', 'firstName', 'lastName', 'cid', 'phone', 'birthdate', 'province', 'amphur', 'tambon', 'addressDetail'];

  requiredFields.forEach(field => {
    const input = document.getElementById(field);
    if (!input.value.trim()) {
      showError(field + 'Error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ');
      isValid = false;
    }
  });

  const cid = document.getElementById('cid').value.trim();
  if (cid && (cid.length !== 13 || !/^\d{13}$/.test(cid))) {
    showError('cidError', '‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å');
    isValid = false;
  }

  const phone = document.getElementById('phone').value.trim();
  if (phone && (phone.length !== 10 || !/^0\d{9}$/.test(phone))) {
    showError('phoneError', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ 0 ‡πÅ‡∏•‡∏∞‡∏°‡∏µ 10 ‡∏´‡∏•‡∏±‡∏Å');
    isValid = false;
  }

  const gender = document.querySelector('input[name="gender"]:checked');
  if (!gender) {
    showError('genderError', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏®');
    isValid = false;
  }

  const userType = document.querySelectorAll('#isPregnant:checked, #isPostpartum:checked, #isGeneral:checked');
    if (userType.length === 0) {
      showError('userTypeError', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó');
      isValid = false;
    }
    
    
      const consent = document.getElementById('consent').checked;
      if (!consent) {
        showError('consentError', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•');
        isValid = false;
      }
    
      return isValid;
    }

    function showError(elementId, message) {
      const errorElement = document.getElementById(elementId);
      errorElement.textContent = message;
      errorElement.style.display = 'block';
    }
    
    function calculateAge(birthDate) {
      const today = new Date();
      const birth = new Date(birthDate);
      let age = today.getFullYear() - birth.getFullYear();
      const monthDiff = today.getMonth() - birth.getMonth();
    
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
      }
    
      return age;
    }
    
    function getAddressNames() {
      return {
        tambon: document.getElementById("tambon").value,
        amphur: document.getElementById("amphur").value,
        province: document.getElementById("province").value
      };
    }
    
    function getSelectedUserTypes() {
      return {
        is_pregnant: document.getElementById("isPregnant").checked,
        is_postpartum: document.getElementById("isPostpartum").checked,
        is_general_user: document.getElementById("isGeneral").checked
      };
    }


async function checkCIDInDatabase() {
  const cidInput = document.getElementById("cid");
  const cid = cidInput.value.trim();
  const cidHint = document.getElementById("cidHint");

  if (cid.length !== 13) {
    cidHint.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å";
    cidHint.style.display = 'block';
    return;
  }

  try {
    const response = await fetch("https://script.google.com/macros/s/AKfycbznTaneNaGDoTwT9Xsgq9XCZDOSspbAbuqeLvkC1teurkY2PwYbk27evsmkULQWONE/exec?check_cid=" + cid);
    const result = await response.json();

    if (result.found) {
      cidHint.textContent = "‚úÖ ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß (‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)";
      fillFormWithData(result.data);
    } else {
      cidHint.textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö";
    }
  } catch (err) {
    cidHint.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
    console.error(err);
  }
}

function fillFormWithData(data) {
  document.getElementById("prefix").value = data.prefix || "";
  document.getElementById("firstName").value = data.first_name || "";
  document.getElementById("lastName").value = data.last_name || "";
  document.getElementById("phone").value = data.phone || "";
  document.getElementById("birthdate").value = data.birthdate || "";

  // ‡πÄ‡∏û‡∏®
  if (data.gender === "‡∏ä‡∏≤‡∏¢") document.getElementById("male").checked = true;
  else if (data.gender === "‡∏´‡∏ç‡∏¥‡∏á") document.getElementById("female").checked = true;

  // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
  document.getElementById("isPregnant").checked = data.is_pregnant === "TRUE";
  document.getElementById("isPostpartum").checked = data.is_postpartum === "TRUE";
  document.getElementById("isGeneral").checked = data.is_general_user === "TRUE";

  // ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
  document.getElementById("moo").value = data.address_moo || "";
  document.getElementById("addressDetail").value = data.address_no || "";

  // ‡πÉ‡∏™‡πà‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏ï‡∏≥‡∏ö‡∏• ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ setTimeout ‡πÉ‡∏´‡πâ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤ options ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
  setTimeout(() => {
    document.getElementById("province").value = data.address_province || "";
    document.getElementById("amphur").value = data.address_amphur || "";
    document.getElementById("tambon").value = data.address_tambon || "";
  }, 300);
}

    function collectFormData() {
      const provinceSelect = document.getElementById("province");
      const amphurSelect = document.getElementById("amphur");
      const tambonSelect = document.getElementById("tambon");
        
      return {
        // üßç‚Äç‚ôÄÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
        prefix: document.getElementById("prefix").value,
        first_name: document.getElementById("firstName").value,
        last_name: document.getElementById("lastName").value,
        birthdate: document.getElementById("birthdate").value,
        cid: document.getElementById("cid").value,
        gender: document.querySelector('input[name="gender"]:checked')?.value || "",
        phone: document.getElementById("phone").value,
    
        // üìç ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
        address_no: document.getElementById("addressDetail").value,
        address_moo: document.getElementById("moo").value,
        address_province: provinceSelect.options[provinceSelect.selectedIndex]?.text || "",
        address_amphur: amphurSelect.options[amphurSelect.selectedIndex]?.text || "",
        address_tambon: tambonSelect.options[tambonSelect.selectedIndex]?.text || "",
    
        // ‚úÖ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏±‡πâ‡∏á true / false)
        is_pregnant: document.getElementById("isPregnant").checked ? "TRUE" : "FALSE",
        is_postpartum: document.getElementById("isPostpartum").checked ? "TRUE" : "FALSE",
        is_general_user: document.getElementById("isGeneral").checked ? "TRUE" : "FALSE",
    
        // üìã ‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°
        consent: document.getElementById("consent").checked ? "TRUE" : "FALSE",
    
        // üîñ ‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏°
        user_id: "",
        staff_id_registered: "",
        related_to_mother_type: "",
    
        // üìÖ ‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        line_registered_at: new Date().toISOString(),
        created_date: new Date().toISOString(),
        updated_date: new Date().toISOString(),
    
        // üìç ‡∏û‡∏¥‡∏Å‡∏±‡∏î
        address_latitude: "",
        address_longtitude: "",
    
        // üìÜ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏
        age_today: calculateAge(document.getElementById("birthdate").value),
    
        // ü™™ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å LIFF
        line_user_id: userProfile?.userId || "",
        line_display_name: userProfile?.displayName || "",
        line_picture_url: userProfile?.pictureUrl || "",
    
        // üõë ‡∏Ñ‡∏£‡∏£‡∏†‡πå‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (admin ‡∏à‡∏∞‡∏°‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á)
        is_high_risk_pregnancy: "",
      };
    }
  
    </script>

</body>
</html>
